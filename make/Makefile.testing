# ============================================================================
# TEST EXECUTION AND COVERAGE ANALYSIS
# ============================================================================
# This module handles test execution, coverage analysis, and test-related
# operations with cross-platform support
#
# Dependencies: Makefile.platform, Makefile.env, Makefile.install
# ============================================================================

# Test configuration
TEST_DIR := tests
SRC_DIR := src
COVERAGE_DIR := htmlcov
COVERAGE_FILE := .coverage

# Test execution parameters
PYTEST_ARGS := --verbose --tb=short
PYTEST_PARALLEL_ARGS := -n auto
PYTEST_COVERAGE_ARGS := --cov=$(SRC_DIR) --cov-report=term --cov-report=html --cov-report=xml

# ============================================================================
# BASIC TEST EXECUTION
# ============================================================================

.PHONY: test test-unit test-integration test-fast test-verbose

test: _load_env ## ðŸ§ª Execute full test suite
	@$(ECHO_CMD) "$(BLUE)Running full test suite...$(NC)\n"
	@$(MAKE) _check_test_deps
	@$(ECHO_CMD) "$(YELLOW)Executing tests with pytest...$(NC)\n"
	@$(PYTHON) -m pytest $(TEST_DIR) $(PYTEST_ARGS)
	@$(ECHO_CMD) "$(GREEN)âœ“ Test suite completed$(NC)\n"

test-unit: _load_env ## ðŸ§ª Execute unit tests only
	@$(ECHO_CMD) "$(BLUE)Running unit tests...$(NC)\n"
	@$(MAKE) _check_test_deps
	@$(ECHO_CMD) "$(YELLOW)Executing unit tests...$(NC)\n"
	@$(PYTHON) -m pytest $(TEST_DIR)/unit $(PYTEST_ARGS) 2>/dev/null || \
	$(PYTHON) -m pytest $(TEST_DIR) -k "unit" $(PYTEST_ARGS) 2>/dev/null || \
	$(PYTHON) -m pytest $(TEST_DIR) -m "unit" $(PYTEST_ARGS) 2>/dev/null || \
	$(PYTHON) -m pytest $(TEST_DIR) $(PYTEST_ARGS)
	@$(ECHO_CMD) "$(GREEN)âœ“ Unit tests completed$(NC)\n"

test-integration: _load_env ## ðŸ§ª Execute integration tests only
	@$(ECHO_CMD) "$(BLUE)Running integration tests...$(NC)\n"
	@$(MAKE) _check_test_deps
	@$(ECHO_CMD) "$(YELLOW)Executing integration tests...$(NC)\n"
	@$(PYTHON) -m pytest $(TEST_DIR)/integration $(PYTEST_ARGS) 2>/dev/null || \
	$(PYTHON) -m pytest $(TEST_DIR) -k "integration" $(PYTEST_ARGS) 2>/dev/null || \
	$(PYTHON) -m pytest $(TEST_DIR) -m "integration" $(PYTEST_ARGS) 2>/dev/null || \
	echo -e "$(YELLOW)âš  No integration tests found or specific marker not defined$(NC)"
	@$(ECHO_CMD) "$(GREEN)âœ“ Integration tests completed$(NC)\n"

test-fast: _load_env ## ðŸ§ª Execute tests in parallel (fast mode)
	@$(ECHO_CMD) "$(BLUE)Running tests in parallel mode...$(NC)\n"
	@$(MAKE) _check_test_deps
	@if $(PYTHON) -c "import pytest_xdist" 2>/dev/null; then \
		echo -e "$(YELLOW)Executing tests with parallel execution...$(NC)"; \
		$(PYTHON) -m pytest $(TEST_DIR) $(PYTEST_ARGS) $(PYTEST_PARALLEL_ARGS); \
	else \
		echo -e "$(YELLOW)pytest-xdist not available, running sequential tests...$(NC)"; \
		$(PYTHON) -m pytest $(TEST_DIR) $(PYTEST_ARGS); \
	fi
	@$(ECHO_CMD) "$(GREEN)âœ“ Fast test execution completed$(NC)\n"

test-verbose: _load_env ## ðŸ§ª Execute tests with verbose output
	@$(call test_execution_pattern,verbose,--verbose --tb=long -v -s)

test-debug: _load_env ## ðŸ§ª Execute tests with debugging enabled
	@$(call test_execution_pattern,debug,--pdb --tb=long -v -s)

# ============================================================================
# COVERAGE ANALYSIS
# ============================================================================

.PHONY: test-coverage coverage coverage-report coverage-html coverage-open coverage-xml

test-coverage: _load_env ## ðŸ§ª Execute tests with coverage reporting
	@$(ECHO_CMD) "$(BLUE)Running tests with coverage analysis...$(NC)\n"
	@$(MAKE) _check_test_deps
	@$(MAKE) _check_coverage_deps
	@$(ECHO_CMD) "$(YELLOW)Executing tests with coverage collection...$(NC)\n"
	@$(PYTHON) -m pytest $(TEST_DIR) $(PYTEST_ARGS) $(PYTEST_COVERAGE_ARGS)
	@$(ECHO_CMD) "$(GREEN)âœ“ Test coverage analysis completed$(NC)\n"

# ============================================================================
# CONSOLIDATED COVERAGE COMMANDS - Phase 2 Optimization
# ============================================================================

coverage: _load_env ## ðŸ§ª ðŸ“Š Flexible coverage command (run 'make coverage help' for options)
	@if [ "$(filter help,$(MAKECMDGOALS))" ]; then \
		echo -e "$(HEADER_COLOR)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"; \
		echo -e "$(HEADER_COLOR)â•‘                     COVERAGE COMMAND OPTIONS                    â•‘$(NC)"; \
		echo -e "$(HEADER_COLOR)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"; \
		echo -e "$(CYAN)Usage: make coverage [option]$(NC)"; \
		echo ""; \
		echo -e "$(YELLOW)Options:$(NC)"; \
		echo -e "  report    Generate terminal coverage report"; \
		echo -e "  html      Generate HTML coverage report"; \
		echo -e "  xml       Generate XML coverage report"; \
		echo -e "  open      Generate and open HTML report in browser"; \
		echo -e "  all       Generate all report formats"; \
		echo ""; \
		echo -e "$(GREEN)Examples:$(NC)"; \
		echo -e "  make coverage report    # Terminal report only"; \
		echo -e "  make coverage html      # HTML report only"; \
		echo -e "  make coverage all       # All formats"; \
	elif [ "$(filter report,$(MAKECMDGOALS))" ]; then \
		$(MAKE) coverage-report-only; \
	elif [ "$(filter html,$(MAKECMDGOALS))" ]; then \
		$(MAKE) coverage-html-only; \
	elif [ "$(filter xml,$(MAKECMDGOALS))" ]; then \
		$(MAKE) coverage-xml-only; \
	elif [ "$(filter open,$(MAKECMDGOALS))" ]; then \
		$(MAKE) coverage-open-only; \
	elif [ "$(filter all,$(MAKECMDGOALS))" ]; then \
		$(MAKE) coverage-all-formats; \
	else \
		echo -e "$(BLUE)Generating standard coverage report...$(NC)"; \
		$(MAKE) coverage-report-only; \
	fi

# Internal coverage command implementations
coverage-report-only: _load_env ## Internal: Generate terminal coverage report
	@$(MAKE) _check_coverage_deps
	@if [ -f $(COVERAGE_FILE) ]; then \
		echo -e "$(YELLOW)Generating terminal coverage report...$(NC)"; \
		$(PYTHON) -m coverage report; \
		echo -e "$(GREEN)âœ“ Terminal coverage report generated$(NC)"; \
	else \
		echo -e "$(RED)âŒ No coverage data found. Run 'make test-coverage' first.$(NC)"; \
		exit 1; \
	fi

coverage-html-only: _load_env ## Internal: Generate HTML coverage report
	@$(MAKE) _check_coverage_deps
	@if [ -f $(COVERAGE_FILE) ]; then \
		echo -e "$(YELLOW)Generating HTML coverage report...$(NC)"; \
		$(PYTHON) -m coverage html; \
		echo -e "$(GREEN)âœ“ HTML coverage report generated in $(COVERAGE_DIR)/$(NC)"; \
	else \
		echo -e "$(RED)âŒ No coverage data found. Run 'make test-coverage' first.$(NC)"; \
		exit 1; \
	fi

coverage-xml-only: _load_env ## Internal: Generate XML coverage report
	@$(MAKE) _check_coverage_deps
	@if [ -f $(COVERAGE_FILE) ]; then \
		echo -e "$(YELLOW)Generating XML coverage report...$(NC)"; \
		$(PYTHON) -m coverage xml; \
		echo -e "$(GREEN)âœ“ XML coverage report generated$(NC)"; \
	else \
		echo -e "$(RED)âŒ No coverage data found. Run 'make test-coverage' first.$(NC)"; \
		exit 1; \
	fi

coverage-open-only: coverage-html-only ## Internal: Generate and open HTML coverage report
	@$(ECHO_CMD) "$(CYAN)Opening HTML coverage report...$(NC)\n"
	@if [ -f "$(COVERAGE_DIR)/index.html" ]; then \
		if command -v open >/dev/null 2>&1; then \
			open "$(COVERAGE_DIR)/index.html"; \
		elif command -v xdg-open >/dev/null 2>&1; then \
			xdg-open "$(COVERAGE_DIR)/index.html"; \
		else \
			echo -e "$(YELLOW)âš  Cannot open browser automatically. Open: $(COVERAGE_DIR)/index.html$(NC)"; \
		fi; \
		echo -e "$(GREEN)âœ“ HTML coverage report opened$(NC)"; \
	else \
		echo -e "$(RED)âŒ HTML report not found$(NC)"; \
		exit 1; \
	fi

coverage-all-formats: _load_env ## Internal: Generate all coverage report formats
	@$(ECHO_CMD) "$(BLUE)Generating all coverage report formats...$(NC)\n"
	@$(MAKE) coverage-report-only
	@$(MAKE) coverage-html-only
	@$(MAKE) coverage-xml-only
	@$(ECHO_CMD) "$(GREEN)âœ“ All coverage reports generated$(NC)\n"

# Legacy commands for backward compatibility (deprecated)
coverage-report: coverage-report-only ## âš ï¸ DEPRECATED: Use 'make coverage report' instead
	@$(ECHO_CMD) "$(YELLOW)âš ï¸ Deprecated: Use 'make coverage report' instead$(NC)\n"

coverage-html: coverage-html-only ## âš ï¸ DEPRECATED: Use 'make coverage html' instead
	@$(ECHO_CMD) "$(YELLOW)âš ï¸ Deprecated: Use 'make coverage html' instead$(NC)\n"

coverage-xml: coverage-xml-only ## âš ï¸ DEPRECATED: Use 'make coverage xml' instead
	@$(ECHO_CMD) "$(YELLOW)âš ï¸ Deprecated: Use 'make coverage xml' instead$(NC)\n"

coverage-open: coverage-open-only ## âš ï¸ DEPRECATED: Use 'make coverage open' instead
	@$(ECHO_CMD) "$(YELLOW)âš ï¸ Deprecated: Use 'make coverage open' instead$(NC)\n"
			open $(COVERAGE_DIR)/index.html; \
		elif command -v xdg-open >/dev/null 2>&1; then \
			xdg-open $(COVERAGE_DIR)/index.html; \
		elif command -v start >/dev/null 2>&1; then \
			start $(COVERAGE_DIR)/index.html; \
		else \
			echo -e "$(YELLOW)Please manually open: $(COVERAGE_DIR)/index.html$(NC)"; \
		fi; \
	else \
		echo -e "$(RED)âŒ HTML coverage report not found$(NC)"; \
		exit 1; \
	fi

# ============================================================================
# SPECIALIZED TEST MODES
# ============================================================================

.PHONY: test-watch test-debug test-profile test-benchmark

test-watch: _load_env ## ðŸ§ª Execute tests in watch mode (continuous)
	@$(ECHO_CMD) "$(BLUE)Starting test watch mode...$(NC)\n"
	@$(MAKE) _check_test_deps
	@if $(PYTHON) -c "import pytest_watch" 2>/dev/null; then \
		echo -e "$(YELLOW)Running tests in watch mode (press Ctrl+C to stop)...$(NC)"; \
		$(PYTHON) -m pytest_watch $(TEST_DIR) -- $(PYTEST_ARGS); \
	else \
		echo -e "$(YELLOW)pytest-watch not available. Install with: pip install pytest-watch$(NC)"; \
		echo -e "$(CYAN)Alternative: Run 'make install-test' to get all development tools$(NC)"; \
		exit 1; \
	fi

test-profile: _load_env ## ðŸ§ª Execute performance profiling on tests
	@$(ECHO_CMD) "$(BLUE)Running test performance profiling...$(NC)\n"
	@$(MAKE) _check_test_deps
	@if $(PYTHON) -c "import pytest_profiling" 2>/dev/null; then \
		echo -e "$(YELLOW)Executing tests with performance profiling...$(NC)"; \
		$(PYTHON) -m pytest $(TEST_DIR) --profile $(PYTEST_ARGS); \
	else \
		echo -e "$(YELLOW)pytest-profiling not available. Install with: pip install pytest-profiling$(NC)"; \
		echo -e "$(CYAN)Running basic timing analysis...$(NC)"; \
		time $(PYTHON) -m pytest $(TEST_DIR) $(PYTEST_ARGS); \
	fi
	@$(ECHO_CMD) "$(GREEN)âœ“ Test profiling completed$(NC)\n"

test-benchmark: _load_env ## ðŸ§ª Execute benchmark tests
	@$(ECHO_CMD) "$(BLUE)Running benchmark tests...$(NC)\n"
	@$(MAKE) _check_test_deps
	@if $(PYTHON) -c "import pytest_benchmark" 2>/dev/null; then \
		echo -e "$(YELLOW)Executing benchmark tests...$(NC)"; \
		$(PYTHON) -m pytest $(TEST_DIR) --benchmark-only $(PYTEST_ARGS); \
	else \
		echo -e "$(YELLOW)pytest-benchmark not available. Install with: pip install pytest-benchmark$(NC)"; \
		echo -e "$(CYAN)Running tests with benchmark marker...$(NC)"; \
		$(PYTHON) -m pytest $(TEST_DIR) -m "benchmark" $(PYTEST_ARGS) 2>/dev/null || \
		echo -e "$(YELLOW)No benchmark tests found$(NC)"; \
	fi
	@$(ECHO_CMD) "$(GREEN)âœ“ Benchmark testing completed$(NC)\n"

# ============================================================================
# TEST FILTERING AND SELECTION
# ============================================================================

.PHONY: test-by-name test-by-marker test-failed test-changed

test-by-name: _load_env ## ðŸ§ª Execute tests matching a name pattern (interactive)
	@$(ECHO_CMD) "$(CYAN)Test filtering by name$(NC)\n"
	@$(ECHO_CMD) "$(YELLOW)Enter test name pattern (e.g., test_database, TestClass, etc.):$(NC)\n"
	@read -p "Pattern: " pattern && \
	echo -e "$(YELLOW)Running tests matching pattern: $$pattern$(NC)" && \
	$(PYTHON) -m pytest $(TEST_DIR) -k "$$pattern" $(PYTEST_ARGS)

test-by-marker: _load_env ## ðŸ§ª Execute tests with specific marker (interactive)
	@$(ECHO_CMD) "$(CYAN)Test filtering by marker$(NC)\n"
	@$(ECHO_CMD) "$(YELLOW)Available markers:$(NC)\n"
	@$(PYTHON) -m pytest --markers 2>/dev/null | grep "^@pytest.mark" || echo "  No custom markers found"
	@$(ECHO_CMD) "$(YELLOW)Enter marker name (e.g., slow, unit, integration):$(NC)\n"
	@read -p "Marker: " marker && \
	echo -e "$(YELLOW)Running tests with marker: $$marker$(NC)" && \
	$(PYTHON) -m pytest $(TEST_DIR) -m "$$marker" $(PYTEST_ARGS)

test-failed: _load_env ## ðŸ§ª Execute only failed tests from last run
	@$(ECHO_CMD) "$(BLUE)Running only failed tests from last run...$(NC)\n"
	@$(MAKE) _check_test_deps
	@if [ -f .pytest_cache/v/cache/lastfailed ]; then \
		echo -e "$(YELLOW)Re-running failed tests...$(NC)"; \
		$(PYTHON) -m pytest --lf $(PYTEST_ARGS); \
	else \
		echo -e "$(YELLOW)No failed tests found. Running full test suite...$(NC)"; \
		$(PYTHON) -m pytest $(TEST_DIR) $(PYTEST_ARGS); \
	fi
	@$(ECHO_CMD) "$(GREEN)âœ“ Failed test execution completed$(NC)\n"

test-changed: _load_env ## ðŸ§ª Execute tests for changed files (requires git)
	@$(ECHO_CMD) "$(BLUE)Running tests for changed files...$(NC)\n"
	@$(MAKE) _check_test_deps
	@if command -v git >/dev/null 2>&1; then \
		changed_files=$$(git diff --name-only HEAD~1 | grep -E "\.(py)$$" | tr '\n' ' '); \
		if [ -n "$$changed_files" ]; then \
			echo -e "$(YELLOW)Changed files: $$changed_files$(NC)"; \
			echo -e "$(YELLOW)Running tests for changed files...$(NC)"; \
			$(PYTHON) -m pytest --co -q $$changed_files 2>/dev/null && \
			$(PYTHON) -m pytest $$changed_files $(PYTEST_ARGS) || \
			echo -e "$(YELLOW)No tests found for changed files, running full suite...$(NC)" && \
			$(PYTHON) -m pytest $(TEST_DIR) $(PYTEST_ARGS); \
		else \
			echo -e "$(YELLOW)No Python files changed, running full test suite...$(NC)"; \
			$(PYTHON) -m pytest $(TEST_DIR) $(PYTEST_ARGS); \
		fi; \
	else \
		echo -e "$(YELLOW)Git not available, running full test suite...$(NC)"; \
		$(PYTHON) -m pytest $(TEST_DIR) $(PYTEST_ARGS); \
	fi

# ============================================================================
# TEST ENVIRONMENT AND DEPENDENCIES
# ============================================================================

.PHONY: _check_test_deps _check_coverage_deps test-deps-info test-deps-install

_check_test_deps: ## Internal: Check test dependencies
	@$(PYTHON) -c "import pytest" 2>/dev/null || \
	(echo -e "$(RED)âŒ pytest not available. Run 'make install-test' first.$(NC)" && exit 1)

test-deps-info: ## ðŸ§ª Display test dependency information
	@$(ECHO_CMD) "$(CYAN)Test Dependencies Information:$(NC)\n"
	@$(ECHO_CMD) "$(YELLOW)Core Testing:$(NC)\n"
	@$(PYTHON) -c "import pytest; print(f'  âœ“ pytest {pytest.__version__}')" 2>/dev/null || echo "  âŒ pytest not available"
	@$(PYTHON) -c "import coverage; print(f'  âœ“ coverage {coverage.__version__}')" 2>/dev/null || echo "  âŒ coverage not available"
	@$(ECHO_CMD) "$(YELLOW)Optional Testing Tools:$(NC)\n"
	@$(PYTHON) -c "import pytest_xdist; print(f'  âœ“ pytest-xdist (parallel execution)')" 2>/dev/null || echo "  â—‹ pytest-xdist not available"
	@$(PYTHON) -c "import pytest_watch; print(f'  âœ“ pytest-watch (watch mode)')" 2>/dev/null || echo "  â—‹ pytest-watch not available"
	@$(PYTHON) -c "import pytest_profiling; print(f'  âœ“ pytest-profiling (performance)')" 2>/dev/null || echo "  â—‹ pytest-profiling not available"
	@$(PYTHON) -c "import pytest_benchmark; print(f'  âœ“ pytest-benchmark (benchmarks)')" 2>/dev/null || echo "  â—‹ pytest-benchmark not available"

test-deps-install: ## ðŸ§ª Install additional test dependencies
	@$(ECHO_CMD) "$(BLUE)Installing additional test dependencies...$(NC)\n"
	@$(ECHO_CMD) "$(YELLOW)Installing pytest extensions...$(NC)\n"
	@$(PIP) install pytest-xdist pytest-watch pytest-profiling pytest-benchmark --quiet
	@$(ECHO_CMD) "$(GREEN)âœ“ Additional test dependencies installed$(NC)\n"

# ============================================================================
# TEST REPORTING AND ANALYSIS
# ============================================================================

.PHONY: test-report test-stats test-duration test-summary

test-report: _load_env ## ðŸ§ª Generate comprehensive test report
	@$(ECHO_CMD) "$(BLUE)Generating comprehensive test report...$(NC)\n"
	@$(MAKE) _check_test_deps
	@$(ECHO_CMD) "$(YELLOW)Running tests with detailed reporting...$(NC)\n"
	@$(PYTHON) -m pytest $(TEST_DIR) $(PYTEST_ARGS) \
		--tb=short \
		--durations=10 \
		--junit-xml=test-report.xml \
		--html=test-report.html --self-contained-html 2>/dev/null || \
	$(PYTHON) -m pytest $(TEST_DIR) $(PYTEST_ARGS) --tb=short --durations=10
	@$(ECHO_CMD) "$(GREEN)âœ“ Test report generated$(NC)\n"

test-stats: _load_env ## ðŸ§ª Display test statistics and metrics
	@$(ECHO_CMD) "$(CYAN)Test Statistics:$(NC)\n"
	@$(MAKE) _check_test_deps
	@$(ECHO_CMD) "$(YELLOW)Test Discovery:$(NC)\n"
	@$(PYTHON) -m pytest --collect-only $(TEST_DIR) 2>/dev/null | grep -E "test session starts|collected" || \
	echo "  Test discovery information not available"
	@$(ECHO_CMD) "$(YELLOW)Test Files:$(NC)\n"
	@find $(TEST_DIR) -name "test_*.py" -o -name "*_test.py" 2>/dev/null | wc -l | sed 's/^/  /' || echo "  0"
	@$(ECHO_CMD) "$(YELLOW)Coverage Files:$(NC)\n"
	@if [ -f $(COVERAGE_FILE) ]; then \
		echo "  âœ“ Coverage data available"; \
		$(PYTHON) -c "import coverage; cov = coverage.Coverage(); cov.load(); print(f'  Total statements: {cov.get_data().measured_files().__len__()}')" 2>/dev/null || echo "  Coverage details not available"; \
	else \
		echo "  âŒ No coverage data found"; \
	fi

test-duration: _load_env ## ðŸ§ª Display test execution duration analysis
	@$(ECHO_CMD) "$(CYAN)Test Duration Analysis:$(NC)\n"
	@$(MAKE) _check_test_deps
	@$(ECHO_CMD) "$(YELLOW)Running tests with duration tracking...$(NC)\n"
	@$(PYTHON) -m pytest $(TEST_DIR) --durations=0 --tb=no -q

test-summary: _load_env ## ðŸ§ª Display quick test summary
	@$(ECHO_CMD) "$(CYAN)Quick Test Summary:$(NC)\n"
	@$(MAKE) _check_test_deps
	@$(ECHO_CMD) "$(YELLOW)Running quick test check...$(NC)\n"
	@$(PYTHON) -m pytest $(TEST_DIR) --tb=no -q

# ============================================================================
# TEST CLEANUP AND MAINTENANCE
# ============================================================================

.PHONY: test-clean test-clean-cache test-clean-coverage test-clean-all

test-clean: ## ðŸ§ª Clean test artifacts and cache
	@$(ECHO_CMD) "$(YELLOW)Cleaning test artifacts...$(NC)\n"
	@$(MAKE) test-clean-cache
	@$(MAKE) test-clean-coverage
	@$(ECHO_CMD) "$(GREEN)âœ“ Test cleanup completed$(NC)\n"

test-clean-cache: ## ðŸ§ª Clean pytest cache
	@$(ECHO_CMD) "$(YELLOW)Cleaning pytest cache...$(NC)\n"
	@rm -rf .pytest_cache
	@rm -rf $(TEST_DIR)/__pycache__
	@find $(TEST_DIR) -name "*.pyc" -delete 2>/dev/null || true
	@find $(TEST_DIR) -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
	@$(ECHO_CMD) "$(GREEN)âœ“ Pytest cache cleaned$(NC)\n"

test-clean-coverage: ## ðŸ§ª Clean coverage reports and data
	@$(ECHO_CMD) "$(YELLOW)Cleaning coverage data...$(NC)\n"
	@rm -f $(COVERAGE_FILE)
	@rm -f coverage.xml
	@rm -rf $(COVERAGE_DIR)
	@$(ECHO_CMD) "$(GREEN)âœ“ Coverage data cleaned$(NC)\n"

test-clean-all: test-clean ## ðŸ§ª Clean all test-related files and reports
	@$(ECHO_CMD) "$(YELLOW)Cleaning all test reports...$(NC)\n"
	@rm -f test-report.xml test-report.html
	@rm -f .coverage.*
	@$(ECHO_CMD) "$(GREEN)âœ“ All test files cleaned$(NC)\n"

# ============================================================================
# TEST DEBUGGING AND DIAGNOSTICS
# ============================================================================

.PHONY: test-debug-info test-doctor test-env-check

test-debug-info: _load_env ## ðŸ§ª Display test debugging information
	@$(ECHO_CMD) "$(CYAN)Test Debug Information:$(NC)\n"
	@$(ECHO_CMD) "$(YELLOW)Test Environment:$(NC)\n"
	@$(ECHO_CMD) "  Python: $(PYTHON)\n"
	@$(ECHO_CMD) "  Test Directory: $(TEST_DIR)\n"
	@$(ECHO_CMD) "  Source Directory: $(SRC_DIR)\n"
	@$(ECHO_CMD) "$(YELLOW)Test Dependencies:$(NC)\n"
	@$(MAKE) test-deps-info
	@$(ECHO_CMD) "$(YELLOW)Test Configuration:$(NC)\n"
	@$(ECHO_CMD) "  pytest.ini: $(if $(wildcard pytest.ini),âœ“ Present,âŒ Missing)\n"
	@$(ECHO_CMD) "  .coveragerc: $(if $(wildcard .coveragerc),âœ“ Present,âŒ Missing)\n"
	@$(ECHO_CMD) "  pyproject.toml: $(if $(wildcard pyproject.toml),âœ“ Present,âŒ Missing)\n"

test-doctor: _load_env ## ðŸ§ª Diagnose test setup issues
	@$(ECHO_CMD) "$(CYAN)Test Doctor - Diagnosing Issues...$(NC)\n"
	@$(ECHO_CMD) "$(YELLOW)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)\n"
	@$(ECHO_CMD) "$(YELLOW)1. Checking test dependencies...$(NC)\n"
	@$(MAKE) _check_test_deps 2>/dev/null && echo -e "$(GREEN)âœ“ Test dependencies available$(NC)" || \
	echo -e "$(RED)Issue: Missing test dependencies$(NC)" && echo -e "$(CYAN)Fix: Run 'make install-test'$(NC)"
	@echo ""
	@$(ECHO_CMD) "$(YELLOW)2. Checking test directory structure...$(NC)\n"
	@if [ -d "$(TEST_DIR)" ]; then \
		echo -e "$(GREEN)âœ“ Test directory exists$(NC)"; \
		test_count=$$(find $(TEST_DIR) -name "test_*.py" -o -name "*_test.py" 2>/dev/null | wc -l); \
		echo -e "$(CYAN)Found $$test_count test files$(NC)"; \
	else \
		echo -e "$(RED)Issue: Test directory missing$(NC)"; \
		echo -e "$(CYAN)Fix: Create $(TEST_DIR) directory and add test files$(NC)"; \
	fi
	@echo ""
	@$(ECHO_CMD) "$(YELLOW)3. Checking source directory...$(NC)\n"
	@if [ -d "$(SRC_DIR)" ]; then \
		echo -e "$(GREEN)âœ“ Source directory exists$(NC)"; \
	else \
		echo -e "$(YELLOW)Warning: Source directory not found$(NC)"; \
		echo -e "$(CYAN)Note: Adjust SRC_DIR in Makefile if needed$(NC)"; \
	fi
	@$(ECHO_CMD) "$(YELLOW)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)\n"

test-env-check: _load_env ## ðŸ§ª Validate test environment setup
	@$(ECHO_CMD) "$(CYAN)Test Environment Check:$(NC)\n"
	@$(ECHO_CMD) "$(YELLOW)Python Environment:$(NC)\n"
	@$(PYTHON) --version
	@$(ECHO_CMD) "$(YELLOW)Module Import Check:$(NC)\n"
	@$(PYTHON) -c "import $(PACKAGE_NAME); print('âœ“ Package can be imported')" 2>/dev/null || \
	echo -e "$(YELLOW)âš  Package import failed - ensure package is installed$(NC)"
	@$(ECHO_CMD) "$(YELLOW)Test Discovery:$(NC)\n"
	@$(PYTHON) -m pytest --collect-only $(TEST_DIR) -q 2>/dev/null | head -5 || \
	echo -e "$(YELLOW)âš  Test discovery failed$(NC)"
